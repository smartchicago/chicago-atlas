- content_for :javascripts do
  = javascript_include_tag "leaflet"
  = javascript_include_tag "leaflet.label"
  = javascript_include_tag "jquery-ui-slider.min"

  :javascript
    $(window).resize(function () {
      var h = $(window).height(),
        offsetTop = 70; // Calculate the top offset

      $('#map').css('height', (h - offsetTop));
    }).resize();


    var geojsonFeature = #{@display_geojson};

    var intervention_locations = #{@intervention_locations};

    var map = L.map('map').setView([41.8781136, -87.66677856445312], 11);

    var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
        key: 'BC9A493B41014CAABB98F0471D759707',
        styleId: 22677
    }).addTo(map);

    map.attributionControl.setPrefix('');

    // control that shows info on hover
    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };

    // get color depending on condition_title
    function getColor(d) {
        #{choropleth_function(@current_dataset.choropleth_cutoffs_json)}
    }

    function style(feature) {
        return {
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
        };
    }

    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
        }
    }

    var geojson;

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
    }

    var allLayers = [];
    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: linkToDetail
        });
        allLayers.push(layer);
    }

    function linkToDetail(e) {
        window.location = '/place/' + e.target.feature.properties.slug + '/#{@current_dataset.slug}';
    }

    geojson = L.geoJson(geojsonFeature, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map);
    
 
    function update_year(year){
    	$("#year_label").text(year);
        for(layer in allLayers){
            var props = allLayers[layer].feature.properties;
            var percentSuffix = '';
            if (props.stat_type == 'percent') percentSuffix = '%';
            allLayers[layer].bindLabel( '<h4>' + props.name + '</h4>' + props.condition_title + ': ' + props.condition_value[ year ] + percentSuffix);
            allLayers[layer].setStyle({fillColor: getColor(props.condition_value[year])});
        }
    }

    var start_year = #{@current_dataset.start_year};
    var end_year = #{@current_dataset.end_year};

    $('#start_year').html(start_year);
    $('#end_year').html(end_year);

    update_year(end_year);
    $("#slider").slider({
      min: start_year,
      max: end_year,
      step: 1,
      value: end_year,
      slide: function(event, ui){
        update_year(ui.value);
      },
      change: function(event, ui){
        update_year(ui.value);
      },
      range: "min"
    });

    var clinicIcon = L.icon({
        iconUrl: '/assets/firstaid.png',
        shadowUrl: '/assets/square-shadow.png',
        iconSize:     [32, 37],
        shadowSize:   [51, 37],
        shadowAnchor: [16, 16]
    });

    for (point in intervention_locations) {
        L.marker([intervention_locations[point][2], intervention_locations[point][3]], {icon: clinicIcon}).addTo(map).bindPopup("<b>" + intervention_locations[point][0] + "</b><br />" + intervention_locations[point][1]);
    }


    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
            grades = #{@current_dataset.choropleth_cutoffs_json},
            labels = [],
            from, to;

        for (var i = 0; i < grades.length; i++) {
            from = grades[i];
            to = grades[i + 1];

            labels.push(
                '<i style="background:' + getColor(from + 1) + '"></i> ' +
                from + (to ? '&ndash;' + to : '+'));
        }

        div.innerHTML = "<strong>#{@current_dataset.name}</strong><br>" + labels.join('<br>');
        return div;
    };

    legend.addTo(map);

.row-fluid
  .span4
    %h4 
      Year
      %small#year_label
    
    %div{ :id => "slider" }
    %strong.pull-left#start_year
    %strong.pull-right#end_year
    
    /
      %ul.inline
        - (@current_dataset.start_year..@current_dataset.end_year).each do |y|
          %li
            - if y.to_s == params[:year]
              %strong
                = y
            - else
              %a{:href => "/map/#{params[:dataset_id]}/#{y}"} 
                = y

    %hr
    - @categories.each do |c|
      %h4
        = c.name

      %ul
        - Dataset.where(:category_id => c.id).order("name").each do |d|
          %li
            - if d.slug == params[:dataset_slug]
              %strong
                = d.name
              - if @intervention_locations.length > 0
                = "(showing #{@intervention_locations.length} clinics)"
            - else
              %a{:href => "/map/#{d.slug}"} 
                = d.name

  .span8
    #map
